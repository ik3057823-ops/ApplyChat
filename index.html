<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Coach Chat</title>
  <style>
    :root{
      --app-w: 920px;
      --bg:#f6f8fc; --panel:#ffffff; --text:#0f172a; --muted:#475569; --border:#e2e8f0;
      --bubble-user:#ecfdf5; --bubble-coach:#f3f4f6; --accent:#2563eb; --accent2:#22c55e; --blue:#2563eb;
      --chip-bg:#eef2ff; --chip-bd:#c7d2fe; --chip-fg:#3730a3;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:#f7f9fc;color:var(--text);font:16px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,sans-serif}
    .app{max-width:var(--app-w);margin:0 auto;min-height:100%;display:flex;flex-direction:column;padding:16px 12px}

    /* ===== Card with header like the screenshot ===== */
    .panel{background:var(--panel);border:1px solid var(--border);border-radius:16px;box-shadow:0 1px 3px rgba(16,24,40,.04)}
    .panel-hd{display:flex;align-items:center;gap:12px;padding:18px;border-bottom:1px solid var(--border)}
    .panel-title{font-weight:700;font-size:20px;color:#0b1220}
    .pill{margin-left:auto;background:#2563eb;color:#fff;border-radius:9999px;padding:4px 10px;font-size:12px;border:1px solid rgba(255,255,255,.35)}

    .panel-body{padding:16px}
    .surface{background:#f3f4f6;border:1px solid var(--border);border-radius:12px;display:flex;flex-direction:column;height:68vh}

    .messages{padding:14px;display:flex;flex-direction:column;gap:12px;overflow:auto;flex:1}
    .msg{display:flex;width:100%}
    .msg.coach{justify-content:flex-start}
    .msg.user{justify-content:flex-end}
    .bubble{max-width:78%;padding:10px 12px;border-radius:14px;border:1px solid var(--border);box-shadow:0 1px 0 rgba(0,0,0,.02);background:var(--bubble-coach)}
    .user .bubble{background:var(--bubble-user)}

    .typing .bubble{display:inline-flex;gap:6px;align-items:center}
    .dot{width:6px;height:6px;border-radius:50%;background:#94a3b8;opacity:.6;animation:blink 1.4s infinite}
    .dot:nth-child(2){animation-delay:.18s}
    .dot:nth-child(3){animation-delay:.36s}
    @keyframes blink{0%,80%,100%{opacity:.3}40%{opacity:1}}

    .input{display:flex;gap:10px;padding:12px;border-top:1px solid var(--border);background:#fff;border-radius:0 0 12px 12px}
    .input textarea{flex:1;resize:none;min-height:44px;max-height:120px;border-radius:12px;border:1px solid #cbd5e1;background:#fff;color:var(--text);padding:10px 12px}
    .btn{border:1px solid #cbd5e1;background:#f8fafc;color:#0f172a;border-radius:12px;padding:10px 16px;cursor:pointer}
    .btn.primary{background:#2563eb;border-color:#2563eb;color:#fff}

    .small{font-size:12px;color:#64748b}
    .chip{display:inline-flex;align-items:center;justify-content:center;gap:6px;font-size:12px;padding:6px 10px;margin:6px 8px 0 0;background:var(--chip-bg);border:1px solid var(--chip-bd);border-radius:9999px;color:var(--chip-fg)}
    .chip.ghost{background:#dbeafe;border-color:#93c5fd;color:#1e40af}

    /* Print entire chat */
    @media print{
      body{background:#fff;color:#000;-webkit-print-color-adjust:exact;print-color-adjust:exact}
      .app{max-width:100%;padding:0}
      .panel{border:0;border-radius:0;box-shadow:none}
      .surface{height:auto}
      .messages{overflow:visible !important;max-height:none !important}
      .input{display:none !important}
      .msg{break-inside:avoid;page-break-inside:avoid}
      .bubble{border:1px solid #ddd}
    }

    .toast{position:fixed;left:50%;bottom:20px;transform:translateX(-50%);background:#111827;border:1px solid #1f2937;color:#e5e7eb;padding:8px 12px;border-radius:8px;font-size:14px;opacity:0;pointer-events:none;transition:opacity .2s}
    .toast.show{opacity:1}
  </style>
</head>
<body>
  <div class="app">
    <div class="panel" id="panel">
      <div class="panel-hd">
        <div class="panel-title">Coach Chat</div>
        <div class="pill" id="practice-pill">Practice 0 / 5</div>
      </div>
      <div class="panel-body">
        <div class="surface">
          <div class="messages" id="messages" role="log" aria-live="polite"></div>
          <div class="input">
            <textarea id="input" placeholder="Type your messageâ€¦ (Enter to send)" aria-label="Your response"></textarea>
            <button class="btn primary" id="send">Send</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="toast" id="toast" role="status" aria-live="polite"></div>

<script>
(function(){
  "use strict";
  /* ==================== DATA ==================== */
  var WORD_BANK = [
    { term: "diet", forms:["diet","diets"], variants:["dietary","dieting"], example:"I follow a balanced diet to stay healthy." },
    { term: "junk food", phrase:"junk food", variants:["junk foods"], example:"In my city, people eat too much junk food." },
    { term: "whole food", phrase:"whole food", variants:["whole foods"], example:"I try to cook with whole foods at home." },
    { term: "food security", phrase:"food security", variants:[], example:"Drought can seriously affect food security." },
    { term: "takeaway", forms:["takeaway","takeaways"], variants:["takeaways"], alsoPhrases:["take away","take-away","take-aways"], example:"I order a takeaway once a week." },
    { term: "processed", forms:["processed"], variants:["processing","processed foods"], example:"Many students rely on processed meals because they are cheap." },
    { term: "perishable", forms:["perishable","perishables"], variants:["perishability"], example:"Perishable goods should be refrigerated immediately." },
    { term: "wholesome", forms:["wholesome"], variants:["wholesomeness","wholesomely"], example:"A wholesome breakfast keeps me energised." },
    { term: "organic", forms:["organic"], variants:["organics","organically"], example:"I prefer organic vegetables when I can afford them." },
    { term: "nutritious", forms:["nutritious"], variants:["nutrition","nutritional","nutritiously","nutritive"], example:"This soup is nutritious and comforting." },
    { term: "consume", forms:["consume","consumes","consumed","consuming"], variants:["consumption","consumer","consumers","consumable","consumables"], example:"People consume too much sugar nowadays." },
    { term: "to be tempted", phrase:"tempted to", variants:["temptation","tempted"], alsoForms:["tempted"], example:"I am tempted to buy crisps after work." },
    { term: "to reduce", forms:["reduce","reduces","reduced","reducing"], variants:["reduction","reductions","reducible"], example:"I plan to reduce my salt intake this month." },
    { term: "to sample", forms:["sample","samples","sampled","sampling"], variants:["sampler","samples"], example:"When I travel, I like to sample local dishes." },
    { term: "to digest", forms:["digest","digests","digested","digesting"], variants:["digestion","digestive"], example:"Drinking warm tea helps me digest a heavy meal." }
  ];

  // Food-topic prompts and easier versions (no IELTS word in UI)
  var QUESTIONS = {
    "diet": "How has your diet changed over the years, and what factors influenced those changes?",
    "junk food": "Why do you think some people prefer junk food even when they know it's unhealthy?",
    "whole food": "Do you think choosing whole foods makes a noticeable difference to health or energy? Why?",
    "food security": "In your view, what are the main causes of weak food security in some communities?",
    "takeaway": "How often do you order a takeaway, and what usually drives that decision?",
    "processed": "What are the advantages and disadvantages of relying on processed foods in busy lives?",
    "perishable": "Which perishable foods do you buy regularly, and how do you prevent waste?",
    "wholesome": "Describe a wholesome meal you enjoy. Why does it make you feel good?",
    "organic": "Do you prefer organic products in certain cases? Which ones and why?",
    "nutritious": "Can convenience food be genuinely nutritious in your experience? Give examples.",
    "consume": "Do people around you consume too much sugar or salt? What habits lead to that?",
    "to be tempted": "When are you most tempted to buy snacks you don't need, and how do you deal with that?",
    "to reduce": "If you wanted to reduce late-night snacking, what practical steps would you take first?",
    "to sample": "Tell me about a time you sampled a new dish or cuisine. What did you think of it?",
    "to digest": "After a heavy meal, what helps you digest comfortably? Share your routine."
  };
  var EASY_QUESTIONS = {
    "diet": "What kind of diet do you follow now? Why?",
    "junk food": "Do you eat junk food often? Why or why not?",
    "whole food": "When do you choose whole foods?",
    "food security": "Is food affordable and available where you live?",
    "takeaway": "How often do you get a takeaway?",
    "processed": "When do you eat processed foods?",
    "perishable": "What perishable foods do you buy each week?",
    "wholesome": "What is a wholesome meal for you?",
    "organic": "Do you buy organic food? Why?",
    "nutritious": "What is a nutritious snack you like?",
    "consume": "Do people you know consume too much sugar?",
    "to be tempted": "When are you tempted to buy snacks?",
    "to reduce": "How would you reduce late-night snacks?",
    "to sample": "Tell me about a new dish you sampled.",
    "to digest": "What helps you digest after a big meal?"
  };

  var PRAISES = [ "Great answer!", "Nice response!", "Well done!", "Excellent!", "That sounds natural!" ];
  var WRONG_TEMPLATES = [ "Almost there -", "Good try -", "Close, but not quite.", "Let's tweak it -", "Small fix needed -" ];

  /* ==================== ELEMENTS ==================== */
  var els = {
    messages: document.getElementById("messages"),
    input: document.getElementById("input"),
    send: document.getElementById("send"),
    toast: document.getElementById("toast"),
    pill: document.getElementById("practice-pill")
  };

  /* ==================== STATE ==================== */
  var STORAGE_KEY = "coach-chat-v15"; // bump to avoid stale state causing parse errors
  var SAVED = {};
  try{ SAVED = JSON.parse(localStorage.getItem(STORAGE_KEY) || "{}"); }catch(e){ SAVED = {}; }
  var SELECT_COUNT = 5;
  var state = { words: [], index: 0, attempts: 0, results: {}, eased: {} };

  function safeSave(){ try{ localStorage.setItem(STORAGE_KEY, JSON.stringify({ words: state.words.map(function(w){return w.term;}), index: state.index, attempts: state.attempts, results: state.results, eased: state.eased })); }catch(e){} }

  /* ==================== UTILS ==================== */
  function shuffle(a){ for(var i=a.length-1;i>0;i--){ var j=Math.floor(Math.random()*(i+1)); var t=a[i]; a[i]=a[j]; a[j]=t; } return a; }
  function escapeHTML(s){ return String(s).replace(/[&<>"']/g, function(c){ return {"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[c]; }); }
  function pick(arr){ return arr[Math.floor(Math.random()*arr.length)]; }

  function tokensOf(str){ var s = String(str||"").toLowerCase().replace(/-/g," "); var out=[], buf=""; for(var k=0;k<s.length;k++){ var ch=s[k]; var ok=(ch>='a'&&ch<='z')||ch==="'"; if(ok){ buf+=ch; } else { if(buf){ out.push(buf); buf=""; } } } if(buf) out.push(buf); return out; }
  function endsWithPunct(s){ var t=String(s||"").trim(); if(!t) return false; var ch=t[t.length-1]; return ".!?".indexOf(ch)!==-1; }

  // Expanded verb detector: auxiliaries/modals, common base verbs, and patterns (e.g., "to + verb")
  var HELPERS={am:1,is:1,are:1,was:1,were:1,be:1,been:1,being:1,do:1,does:1,did:1,can:1,could:1,may:1,might:1,must:1,shall:1,should:1,will:1,would:1,have:1,has:1,had:1};
  var BASE_VERBS={
    help:1, eat:1, shop:1, cook:1, order:1, prefer:1, sample:1, digest:1, reduce:1, consume:1, avoid:1, buy:1, choose:1, think:1, feel:1, enjoy:1, like:1, plan:1, consider:1, believe:1, need:1, want:1, keep:1, make:1, take:1, get:1, give:1, go:1, see:1, find:1, try:1, improve:1, support:1, affect:1, impact:1, change:1, increase:1, decrease:1, grow:1, rise:1, fall:1, snack:1, boil:1, bake:1, drink:1
  };
  function looksLikeVerb(token){
    if(HELPERS[token]) return true;
    if(token.indexOf("n't")!==-1 || token==='not') return true; // negatives allowed
    if(token.length>3 && (token.slice(-2)==='ed' || token.slice(-3)==='ing' || token.slice(-1)==='s')) return true; // inflections
    if(BASE_VERBS[token]) return true; // common base forms
    return false;
  }
  function hasAnyVerb(tokens){
    for(var i=0;i<tokens.length;i++){
      var t=tokens[i];
      if(looksLikeVerb(t)) return true;
      // "to + verb" pattern e.g., "tempted to buy"
      if(t==='to' && i+1<tokens.length){ var nxt=tokens[i+1]; if(nxt && (BASE_VERBS[nxt] || (nxt.length>2 && /[a-z]/.test(nxt)))) return true; }
    }
    return false;
  }

  var SUFFIXES=["s","es","ed","ing","ly","al","ally","ness","ment","ion","tion","sion","ity","ive","ous","er","ers","able","ably"];
  function morphMatches(token, base){ if(token===base) return true; for(var i=0;i<SUFFIXES.length;i++){ if(token===base+SUFFIXES[i]) return true; } return false; }

  /* ==================== SELECTION ==================== */
  function loadOrSelect(){
    if(Array.isArray(SAVED.words) && SAVED.words.length===SELECT_COUNT){
      state.words = SAVED.words.map(function(t){ return WORD_BANK.find(function(w){ return w.term===t; }); }).filter(Boolean);
      state.index = SAVED.index||0; state.attempts=SAVED.attempts||0; state.results=SAVED.results||{}; state.eased=SAVED.eased||{};
    } else {
      state.words = shuffle(WORD_BANK.slice()).slice(0,SELECT_COUNT);
      state.index = 0; state.attempts = 0; state.results = {}; state.eased={};
      safeSave();
    }
  }

  /* ==================== CHAT HELPERS ==================== */
  function addMessage(kind, payload, asHTML){
    var wrap=document.createElement('div'); wrap.className='msg '+kind;
    var bubble=document.createElement('div'); bubble.className='bubble';
    if(asHTML){ bubble.innerHTML = String(payload||''); } else { bubble.textContent = String(payload||''); }
    wrap.appendChild(bubble); els.messages.appendChild(wrap); els.messages.scrollTop=els.messages.scrollHeight; return wrap;
  }
  function coachSay(text){ return addMessage('coach', text, false); }
  function coachSayHTML(html){ return addMessage('coach', html, true); }
  function userSay(text){ return addMessage('user', text, false); }
  function showTyping(){ var w=document.createElement('div'); w.className='msg coach typing'; var b=document.createElement('div'); b.className='bubble'; for(var i=0;i<3;i++){ var d=document.createElement('span'); d.className='dot'; b.appendChild(d);} w.appendChild(b); els.messages.appendChild(w); els.messages.scrollTop=els.messages.scrollHeight; return w; }
  function showToast(msg){ var t=els.toast; if(!t) return; t.textContent=msg; t.classList.add('show'); setTimeout(function(){ t.classList.remove('show'); }, 1400); }

  // Inline actions (delegated)
  els.messages.addEventListener('click', function(e){
    var btn = e.target.closest('[data-action]'); if(!btn) return;
    var act = btn.getAttribute('data-action');
    if(act==='easier'){ makeEasier(btn.getAttribute('data-word')||''); }
  });

  /* ==================== CHECKING ==================== */
  function onTaskFor(word, sentence){
    var s=String(sentence||'').toLowerCase().replace(/-/g,' '); var toks=tokensOf(s);
    if(word.phrase && s.indexOf(word.phrase)!==-1) return true;
    if(word.alsoPhrases && word.alsoPhrases.some(function(p){ return s.indexOf(p)!==-1; })) return true;
    if(word.forms && word.forms.some(function(f){ return toks.indexOf(f)!==-1; })) return true;
    if(word.alsoForms && word.alsoForms.some(function(f){ return toks.indexOf(f)!==-1; })) return true;
    if(word.variants && word.variants.some(function(v){ return toks.indexOf(v)!==-1; })) return true;
    if(word.term.indexOf(' ')===-1){ for(var i=0;i<toks.length;i++){ if(morphMatches(toks[i], word.term)) return true; } }
    if(word.term==='whole food'){ for(var j=0;j<toks.length-1;j++){ if(toks[j]==='whole' && (toks[j+1]==='food'||toks[j+1]==='foods')) return true; } }
    if(word.term==='to be tempted'){ return s.indexOf('tempted to')!==-1 || s.indexOf('temptation to')!==-1; }
    return false;
  }
  function collocationNotes(sentence){
    var s=String(sentence||'').toLowerCase().replace(/-/g,' '); var toks=tokensOf(s); var notes=[];
    function has(t){ return toks.indexOf(t)!==-1; }
    function nextAfter(t){ var i=toks.indexOf(t); return (i>=0&&i<toks.length-1)?toks[i+1]:''; }
    if(has('nutritious')){ var n=nextAfter('nutritious'); var good={meal:1,snack:1,soup:1,food:1,breakfast:1,lunch:1,dinner:1,salad:1,ingredients:1}; if(!good[n]) notes.push('Use "nutritious" before a noun, e.g., "nutritious meal".'); }
    if(has('processed') && !(has('food')||has('foods'))) notes.push('It is natural to say "processed foods".');
    if(has('perishable')||has('perishables')){ if(!(has('food')||has('foods')||has('items')||has('goods')||has('products'))) notes.push('Try "perishable foods" for natural phrasing.'); }
    if(has('wholesome')){ var n2=nextAfter('wholesome'); var ok={meal:1,snack:1,ingredients:1,food:1,soup:1}; if(!ok[n2]) notes.push('"Wholesome" commonly modifies meal, snack, or ingredients.'); }
    if(has('organic') && !(has('produce')||has('vegetable')||has('vegetables')||has('fruit')||has('food')||has('foods'))) notes.push('Try "organic produce" or "organic food".');
    if(has('tempted') && s.indexOf('tempted to')===-1 && s.indexOf('temptation to')===-1) notes.push('Use the pattern "tempted/temptation to + verb".');
    return notes;
  }
  function analyzeAnswer(word, sentence){
    var s=String(sentence||'').trim(); var toks=tokensOf(s); var wordCount=toks.filter(function(x){return /[a-z]/i.test(x);}).length; var notes=[];
    var onTask=onTaskFor(word,s); if(!onTask) notes.push('Try to include the target word (any natural form) in your answer.');
    var hasVerb=hasAnyVerb(toks); if(!hasVerb) notes.push('Include a verb (any form is fine).');
    if(!endsWithPunct(s)) notes.push('Finish with a full stop, question mark, or exclamation mark.');
    if(wordCount<3) notes.push('Write at least three words.');
    var extras=collocationNotes(s); for(var i=0;i<extras.length;i++){ notes.push(extras[i]); }
    var ok=onTask && hasVerb && endsWithPunct(s) && wordCount>=3;
    return { ok:ok, notes:notes };
  }
  function feedbackWrong(notes){ var lead=pick(WRONG_TEMPLATES); var body=notes[0]?notes[0]:'Use the target word (any form), include a verb, and add punctuation.'; var rest=notes.slice(1); var extra=rest.length?(' Also, '+rest.join(' ')):''; return lead+' '+body+extra+' Try again.'; }
  function feedbackRight(word){ var praise=pick(PRAISES); var example=word.example?('<div class="small" style="margin-top:6px">Sample: <code>'+escapeHTML(word.example)+'</code></div>'):''; return '<div>'+escapeHTML(praise)+' - correct</div>'+example; }

  /* ==================== FLOW ==================== */
  function updatePracticePill(){ var done=Object.keys(state.results).length; els.pill.textContent = 'Practice '+done+' / '+state.words.length; }
  function questionFor(word){
    var base = state.eased[word.term] ? EASY_QUESTIONS[word.term] : QUESTIONS[word.term];
    var text = base || ('Talk about your eating habits and try to use "'+word.term+'".');
    var changeBtn = '<button class="chip ghost" data-action="easier" data-word="'+escapeHTML(word.term)+'"><span>Change question</span></button>';
    var chip = '<span class="chip" title="target word">'+escapeHTML(word.term)+'</span>';
    return '<div>'+escapeHTML(text)+'</div><div class="small" style="margin-top:6px">'+chip+changeBtn+'</div>';
  }
  function promptWord(){ var w=currentWord(); coachSayHTML(questionFor(w)); els.input.focus(); }
  function makeEasier(term){ if(!term) return; state.eased[term]=true; safeSave(); var last = els.messages.querySelectorAll('.msg.coach'); if(!last.length) return; var node = last[last.length-1]; var bubble = node.querySelector('.bubble'); if(!bubble) return; var word = state.words[state.index]; if(!word || word.term!==term) return; bubble.innerHTML = questionFor(word); }

  function finish(){
    updatePracticePill();
    var practiced=state.words.map(function(w){return '<span class="chip">'+escapeHTML(w.term)+'</span>';}).join('');
    var html='<div><strong>Nice work â€” all questions done!</strong></div>'+
             '<div class="small" style="margin-top:6px">Words covered:</div>'+
             '<div style="margin-top:6px">'+practiced+'</div>'+
             '<div class="small" style="margin-top:10px">Use your browser\'s Print to save as PDF, or copy the chat below.</div>'+
             '<div style="margin-top:8px;display:flex;gap:8px;flex-wrap:wrap">'+
               '<button class="btn" id="copy-chat">Copy chat</button>'+ 
               '<button class="btn" id="export-pdf">Export PDF</button>'+ 
             '</div>';
    coachSayHTML(html);
    setTimeout(function(){
      var copyBtn=document.getElementById('copy-chat'); var pdfBtn=document.getElementById('export-pdf');
      if(copyBtn) copyBtn.addEventListener('click', copyChat);
      if(pdfBtn) pdfBtn.addEventListener('click', function(){ try{ window.print(); }catch(e){ showToast('Use your browser\'s print to save as PDF.'); } });
    },0);
  }

  function copyChat(){
    var parts=[]; var nodes=els.messages.querySelectorAll('.msg');
    Array.prototype.forEach.call(nodes,function(m){ if(m.classList.contains('typing')) return; var isCoach=m.classList.contains('coach'); var text=m.querySelector('.bubble')?m.querySelector('.bubble').innerText:''; if(text && text.trim()) parts.push((isCoach?'Coach: ':'You: ')+text.trim()); });
    var all = parts.join('\n\n');
    if(navigator.clipboard && navigator.clipboard.writeText){ navigator.clipboard.writeText(all).then(function(){ showToast('Chat copied to clipboard'); }).catch(function(){ legacyCopy(all); }); } else { legacyCopy(all); }
  }
  function legacyCopy(text){ var ta=document.createElement('textarea'); ta.value=text; document.body.appendChild(ta); ta.select(); try{ document.execCommand('copy'); showToast('Chat copied to clipboard'); }catch(e){ showToast('Copy failed'); } finally{ document.body.removeChild(ta); } }

  function handleSubmit(){ var w=currentWord(); var text=String(els.input.value||'').trim(); if(!text) return; userSay(text); els.input.value=''; var typing=showTyping(); setTimeout(function(){ typing.remove(); var analysis=analyzeAnswer(w,text); var feedback=analysis.ok?feedbackRight(w):feedbackWrong(analysis.notes); if(analysis.ok){ coachSayHTML(feedback); } else { coachSay(feedback); } state.attempts+=1; if(analysis.ok){ state.results[w.term]={sentence:text, ok:true}; nextWord(); safeSave(); updatePracticePill(); var completed=Object.keys(state.results).length; if(completed===state.words.length){ finish(); } else { var t=showTyping(); setTimeout(function(){ t.remove(); promptWord(); }, 420); } } else { safeSave(); } }, 400); }

  function currentWord(){ return state.words[state.index]; }
  function nextWord(){ for(var i=0;i<state.words.length;i++){ var idx=(state.index+1+i)%state.words.length; if(!state.results[state.words[idx].term]){ state.index=idx; return; } } }

  els.send.addEventListener('click', handleSubmit);
  els.input.addEventListener('keydown', function(e){ if(e.key==='Enter' && !e.shiftKey){ e.preventDefault(); handleSubmit(); } });

  /* ==================== SELF-TESTS ==================== */
  function assert(cond, msg){ if(!cond) throw new Error(msg); }
  function runSelfTests(){
    console.groupCollapsed('Coach Chat - Self-tests');
    try{
      // tokenization
      assert(JSON.stringify(tokensOf('Nutritious meal.')) === JSON.stringify(['nutritious','meal']), 'Tokenization basic');
      // onTask checks
      assert(onTaskFor({phrase:'junk food'}, 'I avoid junk food.'), 'onTask phrase match');
      assert(onTaskFor({forms:['diet','diets']}, 'I follow a balanced diet.'), 'onTask forms match');
      assert(onTaskFor({phrase:'tempted to'}, 'I was tempted to buy cake.'), 'onTask tempted to');
      // acceptance: >=3 words + punctuation + verb (aux/neg ok)
      var a = analyzeAnswer({term:'nutritious', forms:['nutritious']}, 'Nutritious meals help.');
      assert(a.ok, 'Accepts three words with a verb and punctuation (base verb)');
      a = analyzeAnswer({term:'diet', forms:['diet','diets']}, 'Is a diet helpful?');
      assert(a.ok, 'Accepts auxiliary verb questions');
      a = analyzeAnswer({term:'junk food', phrase:'junk food'}, 'I don\'t eat junk food.');
      assert(a.ok, 'Accepts negative with contraction');
      a = analyzeAnswer({term:'diet', forms:['diet','diets']}, 'Great diet!');
      assert(!a.ok, 'Rejects fewer than 3 words');
      // whole foods adjacency with verb
      a = analyzeAnswer({term:'whole food', forms:null, phrase:'whole food'}, 'Whole foods are great.');
      assert(a.ok, 'Accepts whole foods plus verb');
      // morphological variants (reasonable family)
      a = analyzeAnswer({term:'organic', forms:['organic'], variants:['organically']}, 'I shop organically when possible.');
      assert(a.ok, 'Accepts adverbial variant for organic');
      a = analyzeAnswer({term:'consume', forms:['consume'], variants:['consumption']}, 'Sugar consumption is rising.');
      assert(a.ok, 'Accepts noun variant for consume');
      // punctuation required
      a = analyzeAnswer({term:'diet', forms:['diet','diets']}, 'I follow a healthy diet');
      assert(!a.ok, 'Requires sentence-ending punctuation');
      // easier control label present
      state.words=[{term:'diet'}]; state.index=0; state.eased={}; var html=questionFor({term:'diet'});
      assert(/Change question/.test(html), 'Change question control present');
      // pill updates
      state.words=[{term:'diet'},{term:'junk food'},{term:'organic'},{term:'wholesome'},{term:'consume'}]; state.results={'diet':{ok:true}}; updatePracticePill();
      assert(els.pill.textContent.indexOf('Practice')===0, 'Practice pill updates');
      // newline join is escaped (no raw line breaks in string literal)
      var joined = ['Coach: A','You: B'].join('\n\n');
      assert(joined.indexOf('\n\n')!==-1, 'Join uses escaped newlines');
      console.log('All self-tests passed.');
    }catch(e){ console.error('Self-test failed:', e.message); var warn=document.createElement('div'); warn.className='msg coach'; warn.innerHTML='<div class="bubble small">Self-test failed: '+escapeHTML(e.message)+'</div>'; els.messages.appendChild(warn); }
    finally{ console.groupEnd(); }
  }

  /* ==================== INIT ==================== */
  function init(){
    loadOrSelect();
    updatePracticePill();
    coachSay('I\'ll ask short food-topic questions. Try to use the target word in any natural form. I\'ll mark it correct if your answer uses the word, has at least three words, ends with punctuation, and includes any verb (questions and negatives are fine).');
    promptWord();
    runSelfTests();
  }

  if(document.readyState==='loading'){ document.addEventListener('DOMContentLoaded', init); } else { init(); }
})();
</script>
</body>
</html>
